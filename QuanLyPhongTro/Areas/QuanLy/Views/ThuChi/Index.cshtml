@{
    var thuList = ViewBag.ThuList as List<QuanLyPhongTro.Models.ThuChi> ?? new();
    var chiList = ViewBag.ChiList as List<QuanLyPhongTro.Models.ThuChi> ?? new();

    var tongThu = ViewBag.TongThu ?? 0;
    var tongChi = ViewBag.TongChi ?? 0;
    var loiNhuan = ViewBag.LoiNhuan ?? 0;
}

<div id="finance-section" class="section">
    <!-- Bộ lọc tháng và năm -->
    <div class="flex justify-end mb-6">
        <div class="flex items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
            <!-- Ô chọn tháng -->
            <select id="monthSelect" class="form-select px-3 py-2 rounded-lg border-gray-300">
                <option disabled selected>Chọn tháng</option>
                @for (int i = 1; i <= 12; i++)
                {
                    <option value="@i" @(i == ViewBag.SelectedMonth ? "selected" : "")>Tháng @i</option>
                }
            </select>

            <!-- Ô chọn năm -->
            <select id="yearSelect" class="form-select px-3 py-2 rounded-lg border-gray-300">
                <option disabled selected>Chọn năm</option>
                @for (int y = DateTime.Now.Year - 5; y <= DateTime.Now.Year + 1; y++)
                {
                    <option value="@y" @(y == ViewBag.SelectedYear ? "selected" : "")>@y</option>
                }
            </select>

            <!-- Nút lọc -->
            <button id="filterBtn" class="btn-primary text-white px-4 py-2 rounded-lg flex items-center text-sm">
                <i class="fas fa-filter mr-2"></i>Lọc dữ liệu
            </button>
        </div>
    </div>

    <!-- Tổng quan -->
    <div id="thongkeContainer" class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm font-medium">Tổng thu tháng @ViewBag.SelectedMonth/@ViewBag.SelectedYear</p>
                    <p class="text-3xl font-bold text-green-600 mt-2">@tongThu.ToString("N0") VNĐ</p>
                </div>
                <div class="gradient-green p-3 rounded-lg">
                    <i class="fas fa-arrow-up text-white text-xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm font-medium">Tổng chi tháng @ViewBag.SelectedMonth/@ViewBag.SelectedYear</p>
                    <p class="text-3xl font-bold text-red-600 mt-2">@tongChi.ToString("N0") VNĐ</p>
                </div>
                <div class="gradient-orange p-3 rounded-lg">
                    <i class="fas fa-arrow-down text-white text-xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm font-medium">Lợi nhuận tháng @ViewBag.SelectedMonth/@ViewBag.SelectedYear</p>
                    <p class="text-3xl font-bold text-blue-600 mt-2">@loiNhuan.ToString("N0") VNĐ</p>
                </div>
                <div class="gradient-blue p-3 rounded-lg">
                    <i class="fas fa-chart-line text-white text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Danh sách thu chi -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Thu -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-800">Ghi nhận Thu</h3>
                <button onclick="openModal('incomeModal')" class="btn-primary text-white px-4 py-2 rounded-lg flex items-center text-sm">
                    <i class="fas fa-plus mr-2"></i>Thêm thu
                </button>
            </div>
            <div class="p-6">
                <div class="space-y-4 max-h-96 overflow-y-auto pr-2" id="thuListContainer">
                    @if (thuList.Any())
                    {
                        foreach (var item in thuList)
                        {
                            <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg cursor-pointer"
                                onclick="openEditModal(@item.MaTc, '@item.NoiDung', @item.SoTien, '@item.Ngay?.ToString("yyyy-MM-dd")', 'thu')">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center mr-3">
                                        <i class="fas fa-home text-green-600 text-sm"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm font-medium text-gray-900">@item.NoiDung</p>
                                        <p class="text-xs text-gray-500">@item.Ngay?.ToString("dd/MM/yyyy")</p>
                                    </div>
                                </div>
                                <span class="text-green-600 font-semibold">+@item.SoTien.ToString("N0")</span>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="text-gray-500 text-center py-4">Chưa có dữ liệu thu</p>
                    }
                </div>
            </div>
        </div>

        <!-- Chi -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-800">Ghi nhận Chi</h3>
                <button onclick="openModal('expenseModal')" class="btn-primary text-white px-4 py-2 rounded-lg flex items-center text-sm">
                    <i class="fas fa-plus mr-2"></i>Thêm chi
                </button>
            </div>
            <div class="p-6">
                <div class="space-y-4 max-h-96 overflow-y-auto pr-2" id="chiListContainer">
                    @if (chiList.Any())
                    {
                        foreach (var item in chiList)
                        {
                            <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg cursor-pointer"
                                onclick="openEditModal(@item.MaTc, '@item.NoiDung', @item.SoTien, '@item.Ngay?.ToString("yyyy-MM-dd")', 'chi')">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center mr-3">
                                        <i class="fas fa-tools text-red-600 text-sm"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm font-medium text-gray-900">@item.NoiDung</p>
                                        <p class="text-xs text-gray-500">@item.Ngay?.ToString("dd/MM/yyyy")</p>
                                    </div>
                                </div>
                                <span class="text-red-600 font-semibold">-@item.SoTien.ToString("N0")</span>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="text-gray-500 text-center py-4">Chưa có dữ liệu chi</p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!--script lọc dữ liệu theo tháng năm-->
<script>
         document.addEventListener("click", function (e) {
        if (e.target && e.target.id === "filterBtn") {
            let month = document.getElementById("monthSelect").value;
            let year = document.getElementById("yearSelect").value;

            fetch(`/QuanLy/ThuChi/FilterByMonth?month=${month}&year=${year}`)
                .then(res => res.text())
                .then(html => {
                    document.getElementById("finance-section").innerHTML = html;
                });
        }
    });
</script>

@await Html.PartialAsync("~/Areas/QuanLy/Views/ThuChi/Create.cshtml")

@await Html.PartialAsync("~/Areas/QuanLy/Views/ThuChi/Edit.cshtml")