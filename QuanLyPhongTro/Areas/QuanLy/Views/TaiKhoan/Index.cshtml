@model IEnumerable<QuanLyPhongTro.Areas.QuanLy.Models.ViewModels.TaiKhoanViewModel>

<div id="accounts-section" class="section hidden">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white rounded-xl shadow-sm border border-gray-100">
            <div class="p-6 border-b border-gray-200 flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-800">Quản lý Tài khoản</h3>
                <button onclick="openAddCustomerAccountModal()"
                        class="btn-primary text-white px-4 py-2 rounded-lg flex items-center justify-center">
                    <i class="fas fa-plus mr-2"></i>Thêm tài khoản khách
                </button>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    @if (!Model.Any())
                    {
                        <p class="text-gray-500">Chưa có tài khoản nào.</p>
                    }
                    else
                    {
                        @foreach (var tk in Model)
                        {
                            string initial = tk.VaiTro == "Admin" ? "A" : "K";
                            string color = tk.VaiTro == "Admin" ? "#4F46E5" : "#10B981";
                            string labelClass = tk.VaiTro == "Admin" ? "bg-blue-100 text-blue-800" : "bg-green-100 text-green-800";

                            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 rounded-full flex items-center justify-center mr-4"
                                         style="background-color:@color; color:white; font-weight:bold;">
                                        @initial
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-900">@tk.HoTen</p>
                                        <p class="text-sm text-gray-500">@tk.Email</p>
                                        @if (tk.VaiTro == "Khach")
                                        {
                                            <p class="text-xs text-gray-500">@tk.TenPhong - @tk.DiaChi</p>
                                        }
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="px-3 py-1 @labelClass text-xs font-semibold rounded-full">
                                        @tk.VaiTro
                                    </span>
                                    @if (tk.VaiTro == "Khach")
                                    {
                                        <button class="text-blue-600 hover:text-blue-900" onclick="openEditCustomerAccountModal(@tk.MaTk)" title="Chỉnh sửa tài khoản khách">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    }
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-100">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800">Đổi mật khẩu -Chủ Trọ-</h3>
            </div>
            <div class="p-6">
                <form id="changePasswordForm" class="space-y-4">
                    @Html.AntiForgeryToken()
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Mật khẩu hiện tại</label>
                        <input type="password" name="matKhauCu" class="form-input w-full px-4 py-3 rounded-lg focus:outline-none" placeholder="Nhập mật khẩu hiện tại">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Mật khẩu mới</label>
                        <input type="password" name="matKhauMoi" class="form-input w-full px-4 py-3 rounded-lg focus:outline-none" placeholder="Nhập mật khẩu mới">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Xác nhận mật khẩu mới</label>
                        <input type="password" name="xacNhanMatKhau" class="form-input w-full px-4 py-3 rounded-lg focus:outline-none" placeholder="Nhập lại mật khẩu mới">
                    </div>
                    <button type="submit" id="btnDoiMatKhau" class="w-full btn-primary text-white py-3 rounded-lg font-semibold">
                        <i class="fas fa-key mr-2"></i>Đổi mật khẩu
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById("changePasswordForm").addEventListener("submit", function (e) {
        e.preventDefault();

        const form = this;
        const formData = new FormData(form);
        const token = form.querySelector('input[name="__RequestVerificationToken"]')?.value;

        const matKhauCu = formData.get("matKhauCu")?.trim();
        const matKhauMoi = formData.get("matKhauMoi")?.trim();
        const xacNhanMatKhau = formData.get("xacNhanMatKhau")?.trim();

        if (!matKhauCu || !matKhauMoi || !xacNhanMatKhau) {
            showNotification("Vui lòng nhập đầy đủ thông tin!", "error");
            return;
        }

        if (matKhauMoi !== xacNhanMatKhau) {
            showNotification("Mật khẩu mới và xác nhận không khớp!", "error");
            return;
        }

        $.ajax({
            url: '/QuanLy/TaiKhoan/DoiMatKhau',
            method: 'POST',
            headers: { 'RequestVerificationToken': token },
            data: {
                matKhauCu: matKhauCu,
                matKhauMoi: matKhauMoi,
                xacNhanMatKhau: xacNhanMatKhau
            },
            success: function (data) {
                if (data.success) {
                    showNotification(data.message || "Đổi mật khẩu thành công!", "success");
                    form.reset();
                } else {
                    showNotification(data.message || "Đổi mật khẩu thất bại!", "error");
                }
            },
            error: function (xhr) {
                const errMsg = xhr.responseJSON?.message || xhr.responseText || "Lỗi kết nối đến máy chủ.";
                showNotification("Lỗi: " + errMsg, "error");
            }
        });
    });
</script>

@await Html.PartialAsync("~/Areas/QuanLy/Views/TaiKhoan/Create.cshtml")
@await Html.PartialAsync("~/Areas/QuanLy/Views/TaiKhoan/Edit.cshtml")