@model List<QuanLyPhongTro.Areas.QuanLy.Models.ViewModels.HoaDonViewModel>

<div id="bills-section" class="section hidden"> 
    <div class="bg-white rounded-xl shadow-sm border border-gray-100">
        <!-- ===== Header & Bộ lọc ===== -->
        <div class="p-6 border-b border-gray-200 bg-gray-50">
            <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-4">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 w-full lg:w-3/4">
                    <!-- Lọc trạng thái -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Trạng thái</label>
                        <select id="filterTrangThaiBill" class="form-input w-full px-3 py-2 rounded-lg border-gray-300 focus:ring-2 focus:ring-blue-500">
                            <option value="">Tất cả</option>
                            <option value="Đã thanh toán">Đã thanh toán</option>
                            <option value="Chưa thanh toán">Chưa thanh toán</option>
                        </select>
                    </div>

                    <!-- Lọc tháng -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tháng</label>
                        <select id="filterThangBill" class="form-input w-full px-3 py-2 rounded-lg border-gray-300 focus:ring-2 focus:ring-blue-500">
                            <option value="">Tất cả</option>
                            @for (int i = 1; i <= 12; i++)
                            {
                                <option value="@i">Tháng @i</option>
                            }
                        </select>
                    </div>

                    <!-- Lọc năm -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Năm</label>
                        @{
                            var namHienTai = DateTime.Now.Year;
                        }
                        <select id="filterNamBill" class="form-input w-full px-3 py-2 rounded-lg border-gray-300 focus:ring-2 focus:ring-blue-500">
                            <option value="" @(namHienTai == 0 ? "selected" : "")></option>
                            @for (int year = namHienTai - 4; year <= namHienTai + 1; year++)
                            {
                                <option value="@year" @(year == namHienTai ? "selected" : "")>@year</option>
                            }
                        </select>
                    </div>
                </div>

                <!-- Nút lọc + tạo hóa đơn -->
                <div class="flex flex-wrap gap-3 justify-end lg:w-1/4">
                    <button id="btnLocHoaDon" class="btn-primary text-white px-4 py-2 rounded-lg flex items-center text-sm">
                        <i class="fas fa-filter mr-2"></i> Lọc dữ liệu
                    </button>
                    <button onclick="openModal('createBillModal')" class="btn-primary text-white px-4 py-2 rounded-lg flex items-center">
                        <i class="fas fa-plus mr-2"></i>Tạo hóa đơn
                    </button>
                </div>
            </div>
        </div>
        
        <div class="overflow-x-auto" id="HoaDonTable">
            <table class="min-w-max w-full border-collapse">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mã HĐ</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phòng</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Khách thuê</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kỳ hóa đơn</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tổng tiền</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trạng thái</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ngày tạo</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hạn thanh toán</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thao tác</th>
                    </tr>
                </thead>

                <tbody class="bg-white divide-y divide-gray-200">
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td class="px-6 py-4">@item.MaHoaDonHienThi</td>
                            <td class="px-6 py-4">@item.TenPhong</td>
                            <td class="px-6 py-4">@item.TenKhachThue</td>
                            <td class="px-6 py-4">@item.KyHoaDon</td>
                            <td class="px-6 py-4 font-semibold">@item.TongTien.ToString("N0") VNĐ</td>
                            <td class="px-6 py-4">
                                <span class="@(item.TrangThai == "Đã thanh toán" ? "status-occupied" : "status-maintenance") px-3 py-1 text-xs font-semibold rounded-full text-white"> @item.TrangThai </span>
                            </td>
                            <td class="px-6 py-4 text-blue-600">@item.NgayTao?.ToString("dd/MM/yyyy")</td>
                            <td class="px-6 py-4 @(item.TrangThai == "Chưa thanh toán" ? "text-red-600 font-medium" : "text-gray-500")"> @item.HanThanhToan?.ToString("dd/MM/yyyy") </td>
                            <td class="px-6 py-4">
                                <button onclick="xemChiTietHoaDon(@item.MaHd)" class="text-green-600 hover:text-green-900 mr-3"><i class="fas fa-eye mr-1"></i>Xem</button>
                                @if (item.TrangThai == "Đã thanh toán")
                                {
                                    <button class="text-blue-600 hover:text-blue-900 mr-3"><i class="fas fa-print mr-1"></i>In</button>
                                }
                                else
                                {
                                    <button class="text-blue-600 hover:text-blue-900 mr-3 btn-thanh-toan-hoa-don" data-mahdd="@item.MaHd"><i class="fas fa-credit-card mr-1"></i>Thanh toán</button>
                                    <button class="text-orange-600 hover:text-orange-900 btn-nhac-nho-hoa-don" data-mahdd="@item.MaHd"><i class="fas fa-bell mr-1"></i>Nhắc nhở</button>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    //Lọc hóa đơn
    document.addEventListener("click", async function (e) {
        const btn = e.target.closest("#btnLocHoaDon");
        if (!btn) return;

        const trangThai = document.getElementById("filterTrangThaiBill")?.value || "";
        const thang = document.getElementById("filterThangBill")?.value || "";
        const nam = document.getElementById("filterNamBill")?.value || "";

        const queryParams = new URLSearchParams();
        if (trangThai) queryParams.append("trangThai", trangThai);
        if (thang) queryParams.append("thang", thang);
        if (nam) queryParams.append("nam", nam);

        const url = `/QuanLy/HoaDon/Filter${queryParams.toString() ? "?" + queryParams.toString() : ""}`;

        try {
            const response = await fetch(url, { method: "GET", credentials: "same-origin" });
            if (!response.ok) throw new Error(`Không tải được dữ liệu: ${response.status}`);

            const html = await response.text();
            const root = document.getElementById("bills-section");

            if (root) {
                // Chỉ thay phần bên trong, không thay chính thẻ #bills-section
                const temp = document.createElement("div");
                temp.innerHTML = html;

                const newContent = temp.querySelector("#bills-section");
                if (newContent) {
                    root.innerHTML = newContent.innerHTML;

                    // Gán lại giá trị đã chọn
                    document.getElementById("filterTrangThaiBill").value = trangThai;
                    document.getElementById("filterThangBill").value = thang;
                    document.getElementById("filterNamBill").value = nam;

                    window.scrollTo({ top: root.offsetTop, behavior: "smooth" });
                } else {
                    console.warn("HTML trả về không chứa #bills-section");
                }
            } else {
                console.warn("Không tìm thấy phần tử #bills-section");
            }
        } catch (err) {
            console.error("Lỗi khi lọc hóa đơn:", err);
            showNotification("Đã xảy ra lỗi khi lọc hóa đơn: " + (err.message || err), 'error');
        }
    });

    // Thanh toán hóa đơn
    document.addEventListener("click", async function (e) {
        const btn = e.target.closest(".btn-thanh-toan-hoa-don");
        if (!btn) return;

        const maHd = btn.dataset.mahdd;
        if (!maHd) return;

        const confirmPay = confirm("Xác nhận thanh toán hóa đơn này?");
        if (!confirmPay) return;

        try {
            const res = await fetch(`/QuanLy/HoaDon/ThanhToanHoaDon?maHd=${maHd}`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                }
            });
            const data = await res.json();

            if (data.success) {
                showNotification("✅ " + data.message, 'success');
                // Gọi lại bộ lọc hiện tại để reload danh sách
                document.getElementById("btnLocHoaDon").click();
                reloadThuChiList();
            } else {
                showNotification("⚠️ " + data.message, 'warning');
            }
        } catch (err) {
            showNotification("❌ Lỗi: " + err.message, 'error');
        }
    });

    // Gửi thông báo nhắc nhở thanh toán
    document.addEventListener("click", async function (e) {
        const btn = e.target.closest(".btn-nhac-nho-hoa-don");
        if (!btn) return;

        const maHd = btn.dataset.mahdd;
        if (!maHd) return;

        const confirmSend = confirm("Gửi thông báo nhắc nhở thanh toán hóa đơn này?");
        if (!confirmSend) return;

        try {
            const res = await fetch(`/QuanLy/HoaDon/GuiThongBaoThanhToan?maHd=${maHd}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" }
            });

            const data = await res.json();

            if (data.success) {
                showNotification("✅ " + data.message, "success");
            } else {
                showNotification("⚠️ " + data.message, "warning");
            }
        } catch (err) {
            showNotification("❌ Lỗi: " + err.message, "error");
        }
    });
</script>

@await Html.PartialAsync("~/Areas/QuanLy/Views/HoaDon/Create.cshtml")
@await Html.PartialAsync("~/Areas/QuanLy/Views/HoaDon/View.cshtml")